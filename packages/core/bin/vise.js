#!/usr/bin/env node
import{Command as e}from"commander";import t,{mergeConfig as r}from"vite";import s,{dirname as o}from"path";import n from"glob";import{rename as i,copyFile as a}from"fs/promises";import{$ as c,path as l}from"zx";import{getAppVisePath as u,getAppRoot as p,toKebab as d,EHtmlFixedPositions as f,ScaffoldToPackage as h,fileExist as m,logger as y,mergeConfig as v,replaceContentBetweenMarks as g,replacePlaceholderWithValue as b}from"@vise-ssr/shared";import w,{promises as k}from"fs";import{build as x}from"esbuild";import S from"esbuild-plugin-alias";import R from"@vitejs/plugin-legacy";import C from"@rollup/plugin-node-resolve";import{visualizer as O}from"rollup-plugin-visualizer";import{minify as j}from"html-minifier-terser";import{fileURLToPath as $}from"url";import B from"enquirer";import P from"express";import I from"serialize-javascript";import q from"tapable";async function A(e,t=!1){if(!function(e,t=u()){return!s.relative(t,e).startsWith("../")}(e))throw"Can NOT operate files outside root";c.verbose=!1;const r=await(c`mkdir -p ${e}`);return t&&await(c`rm -rf ${e}/*`),0===r.exitCode}async function E(e){await A(e,!0)}async function F(e){let t;try{await k.access(e,w.constants.F_OK);const r=await async function(e){const t=await x({absWorkingDir:process.cwd(),entryPoints:[e],outfile:"out.js",write:!1,platform:"node",bundle:!0,format:"esm",sourcemap:"inline",metafile:!0,plugins:[S({"@/":`${s.resolve(s.dirname(e),"src")}/`}),{name:"externalize-deps",setup(e){e.onResolve({filter:/.*/},(e=>{const t=e.path;if("."!==t[0]&&!t.startsWith("@/")&&!s.isAbsolute(t))return{external:!0}}))}},{name:"replace-import-meta",setup(e){e.onLoad({filter:/\.[jt]s$/},(async e=>{const t=await w.promises.readFile(e.path,"utf8");return{loader:e.path.endsWith(".ts")?"ts":"js",contents:t.replace(/\bimport\.meta\.url\b/g,JSON.stringify(`file://${e.path}`)).replace(/\bimport\.meta\.env\.SSR\b/g,JSON.stringify(!0)).replace(/\bimport\.meta\.env\b/g,JSON.stringify({})).replace(/\b__dirname\b/g,JSON.stringify(s.dirname(e.path))).replace(/\b__filename\b/g,JSON.stringify(e.path))}}))}}]}),{text:r}=t.outputFiles[0];return{code:r}}(e),o=`${e}.js`;await k.writeFile(o,r.code),t=(await H(`${o}?t=${Date.now()}`)).default,await k.unlink(o)}catch(e){console.error("[dynamicImportTs error]",e)}return t}const H="undefined"==typeof jest?new Function("file","return import(file)"):require,N={devPort:3e3,htmlClass:"",htmlFixedPositionFragments:[],defaultTitle:"Vise Powered App",faviconLink:"/logo.svg",hmrPort:3008,useFlexible:!1,directiveTransforms:{},ssr:{},base:"/",routerSyncPages:[],resolve:{},build:{},plugins:[],customTemplate:"",strictInitState:!0,scaffold:"vue3-app",htmlMinify:!0,routerBase:"/"};let L;async function J(){if(L)return L;let e;const t=`${p()}/vise.config.ts`,r=await F(t);if(void 0===r)return console.error("[getAppViseConfig error]"),Object.assign({},N);if(e=Object.assign({},N,r),!e.base.match(/^(\/|https?:\/\/)/))throw"[vise.config.js]: base must start with a slash or http";return L=e,e}const T={minifyCSS:!0,minifyJS:!0,collapseBooleanAttributes:!0,collapseInlineTagWhitespace:!0,collapseWhitespace:!0,conservativeCollapse:!0,decodeEntities:!0,removeAttributeQuotes:!0,removeScriptTypeAttributes:!0,removeStyleLinkTypeAttributes:!0};function V(e,{position:t,content:r}){const s=`\x3c!--comment-${d(t)}-inserted--\x3e`;if(e.indexOf(s)>=0)return e;const o=("function"==typeof r?r():r)||"";return t===f.headEnd?e.replace(/<\/head>/,`${o}${s}</head>`):e}function z(e,t){const r=function(e,t){return e?0===t.length?e:void 0:""}(e,t);return void 0!==r?r:t.reduce(V,e)}function W(e,t){return async function(r,o){r&&await Promise.all(Object.values(o).map((async r=>{if(!function(e){return"asset"===e.type&&"index.html"===s.basename(e.fileName)}(r))return;const o=z(r.source,e);r.source=await async function(e,t){return!1===t?e:j(e,!0===t?T:t)}(o,t)})))}}function D(e){const{minifyOption:t,isProduction:r=!1,htmlFixedPositionFragments:s=[]}=e||{};return{name:"vise:scaffold-post",enforce:"post",transformIndexHtml:e=>r||!e?e:z(e,s),generateBundle:W(s,t)}}const _=o($(import.meta.url));async function U(e,t){const o=await J(),{hmrPort:n,ssr:i,base:a="/",resolve:c={},build:l={},plugins:u=[]}=o,p="production"===t.mode,d=r({root:e,build:{emptyOutDir:!0},optimizeDeps:{include:"react-app"===o.scaffold?["react-dom/client"]:[]},resolve:{extensions:[".ts",".js",".tsx",".jsx"],alias:[{find:"~",replacement:s.resolve(e,"./")},{find:"@/",replacement:`${s.resolve(e,"src")}/`}]},plugins:[C({preferBuiltins:!0}),D({isProduction:p,htmlFixedPositionFragments:o.htmlFixedPositionFragments||[],minifyOption:o.htmlMinify})]},t),f=await async function(e,t,r){const{getScaffoldPlugins:s}=await import(h[r.scaffold]);return s(e,t,r)}(e,p,o);return r(d,{base:a,server:{hmr:{...n?{port:n}:{}}},...i?{ssr:i}:{},...c?{resolve:c}:{},...l?{build:l}:{},plugins:[...u,...f]})}async function M(){const e=JSON.parse(await k.readFile(s.resolve(_,"../package.json"),"utf8"));return Object.keys(e.dependencies)}async function K(){const e=u(),r=p(),o=await J(),c=s.resolve(r,"src/pages"),l=await async function(e){return U(e,{mode:"production",build:{sourcemap:!0,manifest:!0,ssrManifest:!0,minify:"terser",outDir:"./dist/client"},plugins:[R(),O({filename:"client-stats.html",sourcemap:!0,gzipSize:!0,brotliSize:!0})]})}(r),d=await async function(e){const t=await U(e,{mode:"production",build:{rollupOptions:{input:[s.join(u({root:e}),"entry-server.ts"),s.resolve(e,"src/server-hooks.ts")],output:{format:"esm"}},sourcemap:!0,ssr:!0,minify:"terser",outDir:"./dist/server"},ssr:{external:["vise-ssr","cookie","redux","react-redux","react-router-dom/*","url"],noExternal:["@reduxjs/toolkit"]},plugins:[O({filename:"server-stats.html",sourcemap:!0,gzipSize:!0,brotliSize:!0})]}),r=t?.build?.rollupOptions?.output;return r&&(Array.isArray(r)?t.build.rollupOptions.output=r.map((e=>({...e,manualChunks:void 0}))):r.manualChunks=void 0),t}(r);await E(e),await t.build(l),await t.build(d),await i(`${r}/dist/client/ssr-manifest.json`,`${r}/dist/server/ssr-manifest.json`);const f="react-app"===o.scaffold?"tsx":"vue",h=n.sync(`*.${f}`,{cwd:c}).filter((e=>e!==`index.${f}`)).map((e=>{const t=s.basename(e,`.${f}`);return a(`${r}/dist/client/index.html`,`${r}/dist/client/${t}.html`)}));await Promise.all(h)}const Q="single",G="multi";const X=async(e,t)=>{if(!await m(l.join(e,"./src/server-hooks.ts")))return void y.error("不存在 server-hooks 文件，非 vise 项目");if(await m(l.join(e,"./dist/server/entry-server.js")))return c.verbose=!0,ee(e,t,Q);y.error("请先在该项目内运行 vise build")},Y=async(e,t)=>{const r=(await(c`ls ${e}`)).stdout.split("\n").filter((e=>!!e));if(await Z(e,r))return c.verbose=!0,ee(e,t,G);y.error("非法目录: 不支持 vise serve, 目录格式请见 vise 官网")},Z=async(e,t)=>(await Promise.all(t.map((t=>{const r=l.join(e,`./${t}`,"./server/server-hooks.js");return m(r)})))).filter((e=>!!e)).length,ee=async(e,t,r)=>{let s="";r===G&&(s="-b");const o=`-p ${t.port} -c ${t.enableCache} -r ${t.repeatRender}`;return await(c`vise-express start ${s} ${o} ${e}`)};function te(e,t){let r=e.template;if(t.title){const e=!t.title||`<title>${String(t.title)}</title>`;r=g({source:r,mark:"TITLE",replacement:e,mode:"html"})}var s;return r=b(r,"initState",(s=t.initState||{},`<script>try { window.Vise.initState = ${I(s)}; } catch (err) { console.error('[Vise] fail to read initState.'); }<\/script>`)),Object.keys(e).reduce(((t,r)=>{const s=e[r]??"";return b(t,r,s)}),r)}const re=["receiveRequest","requestResolved","beforeUseCache","findCache","hitCache","beforeRender","render","afterRender","beforeResponse"],se={receiveRequest:"receiveRequestInner",findCache:"findCacheInner"};class oe{hooks={};tap(e){Object.keys(e).forEach((t=>{const r=e[t];r&&r.forEach((e=>{this[t].tapPromise("vise",e)}))}))}createIfEmpty(e,t){return this.hooks[e]||(this.hooks[e]=t()),this.hooks[e]}get receiveRequest(){return this.createIfEmpty("receiveRequest",(()=>new q.AsyncParallelBailHook(["request"])))}get receiveRequestInner(){return this.createIfEmpty("receiveRequestInner",(()=>new q.AsyncParallelBailHook(["request"])))}get requestResolved(){return this.createIfEmpty("requestResolved",(()=>new q.AsyncSeriesWaterfallHook(["resolvedRequest"])))}get beforeUseCache(){return this.createIfEmpty("beforeUseCache",(()=>new q.AsyncParallelBailHook(["renderContext"])))}get findCache(){return this.createIfEmpty("findCache",(()=>new q.AsyncParallelBailHook(["cacheInfo"])))}get findCacheInner(){return this.createIfEmpty("findCacheInner",(()=>new q.AsyncParallelBailHook(["cacheInfo"])))}get hitCache(){const e="hitCache";return this.hooks[e]||(this.hooks[e]=new q.AsyncParallelHook(["hitCache"])),this.hooks[e]}get beforeRender(){return this.createIfEmpty("beforeRender",(()=>new q.AsyncSeriesWaterfallHook(["renderContext"])))}get render(){return this.createIfEmpty("render",(()=>new q.AsyncParallelBailHook(["renderContext"])))}get afterRender(){return this.createIfEmpty("afterRender",(()=>new q.AsyncSeriesWaterfallHook(["renderResult"])))}get beforeResponse(){return this.createIfEmpty("beforeResponse",(()=>new q.AsyncParallelBailHook(["renderResult"])))}}function ne(e,t){return null!==e&&null!==t&&(e instanceof Array?(r=e,(s=t)instanceof Array&&r.length===s.length&&-1===r.findIndex(((e,t)=>!ie(s[t],e)))):!(t instanceof Array)&&function(e,t){if("object"!=typeof t)return!1;if(Object.keys(e).length!==Object.keys(t).length)return!1;return-1===Object.keys(e).findIndex((r=>!(r in t)||!ie(e[r],t[r])))}(e,t));var r,s}function ie(e,t){return e===t||typeof e==typeof t&&ne(e,t)}class ae{hooks;logger;constructor(e,t){this.hooks=e,this.logger=t}async receiveRequest(e){const t=await this.hooks.receiveRequestInner.promise(e);return void 0!==t&&this.log("receiveRequest",t),t}async requestResolved(e){const t="requestResolved",r=await this.hooks[t].promise(e);return ie(r.original,r.resolved)||this.log(t,r),r}async beforeUseCache(e){const t="beforeUseCache",r=await this.hooks[t].promise(e);return void 0!==r&&this.log(t,r),r}async findCache(e){const t=await this.hooks.findCacheInner.promise(e);return void 0!==t&&this.log("findCache",t),t}async hitCache(e){const t="hitCache";this.hooks[t].promise(e),this.log(t,e)}async beforeRender(e){const t="beforeRender",r=await this.hooks[t].promise(e);return ie(r,e)||this.log(t,r),r}async render(e){const t="render",r=await this.hooks[t].promise(e);return this.log(t,r),r}async afterRender(e){const t="afterRender",r=await this.hooks[t].promise(e);return ie(r,e)||this.log(t,r),r}async beforeResponse(e){const t="beforeResponse",r=await this.hooks[t].promise(e);return void 0!==r&&this.log(t,r),r}log(e,t){this.logger?.log(e,t)}}const ce=function(){let e=[];return function(t){return e=[],function(t){if(null===t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(ce);const r=e.find((e=>e[0]===t))?.[1];if(r)return r;const s={};return e.push([t,s]),Object.keys(t).reduce(((e,r)=>(e[r]=ce(t[r]),e)),s)}(t)}}(),le=/^(vise-plugin-|app-|vise:)[a-z]([a-z0-9-]*[a-z0-9])?$/;function ue(e,t,r){switch(t){case"receiveRequest":case"render":return async function(...t){const s=await r(...t);return s&&(s.renderBy=e),s};case"afterRender":return async function(t){const s=await r({...t});return ie(t,s)||(s.renderBy=e),s};case"requestResolved":return async function(e){const t=r,s=ce(e.original),{resolved:o}=await t(e);return{original:s,resolved:o}};case"findCache":return async function(t){const s=await r(t);if(s)return{content:s,renderBy:e}}}return r}const pe=(e,t)=>e.filter((e=>e.enforce===t)).map((e=>e.callback));function de(e){return e.reduce(((e,t)=>{const{name:r,hooks:s}=t;return Object.keys(s).reduce(((e,t)=>{const o=s[t];if(!o)return e;const n=function(e,t,r,s){return(Array.isArray(s)?s:[s]).map((e=>"callback"in e?e:{callback:e})).reduce(((r,s)=>[...r,{...s,callback:ue(e,t,s.callback)}]),r??[])}(r,t,e[t],o),i=Object.prototype.hasOwnProperty.call(se,t)?se[t]:t;return{...e,[i]:n}}),e)}),{})}function fe(e){const t=function(e){const t=re.reduce(((t,r)=>e[r]?{...t,[r]:e[r]}:t),{});return[...e.plugins??[],{name:`app-${e.appName}`,hooks:t}]}(e);t.forEach((({name:e})=>{if(!e.match(le))throw`illegal vise plugin name: ${e}`}));const r=function(e){return Object.keys(e).reduce(((t,r)=>({...t,[r]:[...pe(e[r],"pre"),...pe(e[r],void 0),...pe(e[r],"post")]})),{})}(de(t));return r}const he=200,me=500;class ye{hookCaller;constructor(e,t){const r=fe(e),s=new oe;s.tap(r),this.hookCaller=new ae(s,t)}async start(e,t={}){const r={title:"",noCache:!1,initState:{},routerBase:"/",...t},{routerBase:s}=r,{url:o}=e;let n=o.substring(o.indexOf(s)+s.length);n.startsWith("/")||(n=`/${n}`);const i={...e,url:n},a={request:i,extra:r},c=await this.hookCaller.receiveRequest(i);if(void 0!==c)return this.end({type:"receiveRequest",context:c.context,renderBy:c.renderBy});const{resolved:l}=await this.hookCaller.requestResolved({original:a,resolved:{request:{...i},extra:{...r}}}),u=await this.callCacheHooks(l);if("content"in u)return this.end({...u,context:l,type:"hitCache"});const p=await this.hookCaller.beforeRender(l),d=await this.callRenderHooks(p,u.cacheInfo);return this.end(d)}async callCacheHooks(e){const t=await this.hookCaller.beforeUseCache(e);if(t?.key){const e=await this.hookCaller.findCache(t);if(e){const r={...t,content:e.content};return this.hookCaller.hitCache(r),{cacheInfo:t,...e}}return{cacheInfo:t}}return{}}async callRenderHooks(e,t){let r;const{error:s}=e,o=t=>({type:"error",renderBy:"vise:core",context:e,error:t});if(s)return o(s);try{r=await this.hookCaller.render(e)}catch(e){r=o({code:me,message:e instanceof Error?e.message:String(e),detail:e instanceof Error?{stack:e.stack}:void 0})}return t&&"render"===r.type&&(r.cacheInfo=t),r}async end(e){const t=await this.hookCaller.afterRender(e),r=await this.hookCaller.beforeResponse(t);if(r)return r;let s,o=he;switch(e.type){case"hitCache":s=e.content;break;case"error":o=e.error.code,s=e.error.message;break;case"receiveRequest":o=me,s="Fatal Error: Hooks intercept the request with receiveRequest without finish rendering";break;default:s=e.ssrResult.html}return{code:o,body:s,headers:{"content-type":"text/html; charset=utf-8"}}}}class ve{static mapHookLogProcessor={receiveRequest(e,t){const r=e;return JSON.stringify(t?r:{renderBy:r.renderBy,extra:r.context.extra})},requestResolved(e,t){const{resolved:r}=e,{extra:s}=r;return JSON.stringify(t?r:{...r,extra:{...s,initState:s.initState?JSON.stringify(s.initState).substring(0,100):null}})},findCache(e,t){const r=e;return JSON.stringify(t?r:{renderBy:r.renderBy,content:`${r.content.substring(0,100)}...`})},render(e,t){const r=e;let s;if("error"===r.type)s=`render failed with: ${JSON.stringify(r.error)}`;else if("render"===r.type){if(t)return JSON.stringify(r);s=`${r.ssrResult.app.substring(0,100)}...`}return JSON.stringify({renderBy:r.renderBy,result:s})},afterRender(e,t){const r=e;if(t)return JSON.stringify(r);const s={renderBy:r.renderBy,context:{request:{url:r.context.request.url},extra:r.context.extra}};return"error"===r.type?s.error=r.error:s.type=r.type,JSON.stringify(s)},beforeResponse(e,t){const r=e;return r?JSON.stringify(t?r:{...r,body:r.body?`${r.body.substring(0,100)}...`:""}):""}};doLog;fullLog;constructor(e=console.log,t=!1){this.doLog=e,this.fullLog=t}log(e,t){if("hitCache"===e)return;const r=ve.mapHookLogProcessor[e]?ve.mapHookLogProcessor[e](t,this.fullLog):JSON.stringify(t);""!==r&&this.doLog(`[hook] "${e}" intercept with: ${r}`)}}const ge="test"===process.env.NODE_ENV||!!process.env.VITE_TEST_BUILD;class be{appRoot;appVisePath;express;scaffold;mapScaffoldFiles={};viteServer;port;hookLifeCycle;hooks={async render(e){const{request:t}=e,r=await this.viteServer.transformIndexHtml(t.url,""),s=this.resolve(this.mapScaffoldFiles.serverEntry),o=(await this.viteServer.ssrLoadModule(s)).render,n=await o(e);if(!n||"code"in n)return{type:"error",renderBy:"vise:dev-server",error:n??{code:500,message:"Render fail"},context:e};const{extra:i,...a}=n,c={renderBy:"vise:dev-server",type:"render",context:v(e,{extra:i}),ssrResult:{...a,template:r}};return v(l=c,{ssrResult:{html:te(l.ssrResult,l.context.extra)}});var l},async beforeResponse(e){this.log(`page render: ${e.renderBy}`)}};routerBaseConfigs={};constructor(e,t,r){this.appRoot=e,this.appVisePath=u({root:e}),this.scaffold=t,this.initScaffoldFiles(),this.port=r,this.express=P(),this.initHooks()}start(){this.express.listen(this.port,(()=>{this.log(`ssr server started: http://localhost:${this.port}`)}))}async createServer(){return await E(this.appVisePath),this.setupExpress(),{app:this.express,vite:this.viteServer}}async initScaffoldFiles(){this.mapScaffoldFiles=(await import(h[this.scaffold])).SCAFFOLD_FILES}async loadAppHookConfig(){const e=s.resolve(this.appRoot,"src/server-hooks.ts");return await F(e)}async initHooks(){try{await this.initViteServer();const e=await this.loadAppHookConfig();if(e){const{routerBase:t}=await J(),{appName:r}=e,s="string"==typeof t?t:t.map((e=>e.toString()));this.routerBaseConfigs[r]=s,this.hookLifeCycle=new ye(this.addServerPlugin(e),new ve(this.log.bind(this))),this.log(`server hooks for app-${r} installed`)}else this.log("no server hooks found")}catch(e){throw console.error("[Vise] loadServerHooks fail",e),e}this.createServer()}addServerPlugin(e){const t=Object.keys(this.hooks).reduce(((e,t)=>({...e,[t]:this.hooks[t].bind(this)})),{});return{...e,plugins:[...e.plugins??[],{name:"vise:dev-server",hooks:t}]}}setupExpress(){const e=this.viteServer;this.express.use(e.middlewares),this.express.use("*",((t,r)=>{if(!this.hookLifeCycle)return void this.sendResponse(r,{code:500,headers:{},body:"Fail to init HookLifeCycle"});const{projectName:s,routerBase:o}=function(e,t){let r="/";return{projectName:Object.keys(e).sort(((t,r)=>e[r].length-e[t].length)).find((s=>{const o=e[s];return"string"==typeof o&&-1!==t.indexOf(o)?(r=o,!0):"string"!=typeof o&&o.some((e=>{let s=e;s.startsWith("/")&&(s=s.substring(1)),s.endsWith("/")&&(s=s.substring(0,s.length-1));const o=new RegExp(s),[n]=t.match(o)??[];return!!n&&(r=n,!0)}))}))??"",routerBase:r}}(this.routerBaseConfigs,t.originalUrl);if(!s)return void this.sendResponse(r,{code:404,headers:{},body:"Not Found"});(async()=>{try{const e=await this.hookLifeCycle.start({url:t.originalUrl,headers:t.headers,body:t.body},{routerBase:o});this.sendResponse(r,e)}catch(t){const s=e=>"string"==typeof e.stack,o=s(t)?t.stack:t;s(t)&&e.ssrFixStacktrace(t),console.log(o),this.sendResponse(r,{code:500,headers:{},body:String(o)})}})()}))}async initViteServer(){const e=await async function(e){return U(e,{mode:"development",server:{middlewareMode:"ssr",watch:{usePolling:!0,interval:100}},ssr:{external:["vise-ssr","cookie","redux","react-redux","react-router-dom/*","url",...await M()],noExternal:["@reduxjs/toolkit"]},build:{rollupOptions:{input:s.resolve(e,"index.html")}}})}(this.appRoot),r=v(e,{logLevel:ge?"error":"info"}),o=await t.createServer(r);return this.viteServer=o,o}log(e){console.log(`[Vise] ${e}`)}async sendResponse(e,t){e.set(t.headers).status(t.code).end(t.body??"")}resolve(e){return s.resolve(this.appVisePath,e)}}!async function(){const t=new e;t.name("vise").description("Vise is a SSR framework for website. More info: https://vise.com/").version(await async function(){const e=await k.readFile(s.resolve(_,"../package.json"),"utf8");return JSON.parse(e).version}()),t.command("build").description("build vise project for production").action((()=>{K()})),t.command("dev").description("launch dev web server").option("-p,--port <port_number>","web port").action((async e=>{const t=await J(),r=(e.port?Number(e.port):t.devPort)??3e3,s=function(e,t){const r=p();return new be(r,e,t)}(t.scaffold,r);s.start()})),t.command("create").description("create new app").action((()=>{!async function(){const e=await B.prompt([{type:"select",message:"请选择项目类型：",name:"templateType",choices:Object.keys(h)}]),{creator:t}=await import(h[e.templateType]);t()}()})),t.command("serve").description("start SSR HTTP server with built vise app dir or vise project bundles").argument("[viseAppDir]").option("-p, --port <port>","server listen port",String(3e3)).option("-c, --enable-cache <trueOrFalse>","enable server cache","true").option("-r, --repeat-render <times>","repeat ssr for benchmark test","0").action(((e,t)=>{!async function(e,t){c.verbose=!1;const r=l.resolve(process.cwd(),e||""),s=await m(l.join(r,"./package.json"));!e||s?X(r,t):Y(r,t)}(e,t)})),t.parse(process.argv)}();
