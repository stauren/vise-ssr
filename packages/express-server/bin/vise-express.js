#!/usr/bin/env node
import e,{dirname as s}from"path";import{Command as t}from"commander";import{$ as r}from"zx";import n from"express";import i from"cors";import{getAppVisePath as o,mergeConfig as a,RenderResultCategory as c,HookLifeCycle as d,HookLogger as h,matchAppForUrl as u}from"vise-ssr";import{fileURLToPath as p}from"url";import{fork as l}from"child_process";class f{caches={};count=0;removeOutdated(){Object.keys(this.caches).forEach((e=>{const[s]=this.caches[e];Date.now()-s>3e5&&(delete this.caches[e],this.count=this.count-1)}))}removeEarliest(){const{key:e}=Object.keys(this.caches).reduce(((e,s)=>{const[t]=this.caches[s];return t<e.cacheTime?{cacheTime:t,key:s}:e}),{cacheTime:Number.POSITIVE_INFINITY,key:""});this.caches[e]&&(delete this.caches[e],this.count=this.count-1)}set(e,s){if(e){if(!this.caches[e]){for(;this.count>=100;)this.removeEarliest();this.count=this.count+1}this.caches[e]=[Date.now(),s]}}get(e){this.removeOutdated();const s=this.caches[e];if(s)return s[1]}}function g(e){console.log(`[vise ssr]: ${e}`)}const m=s(p(import.meta.url));function y(s){return e.join(o({root:s}),"bundles")}function v(s,t){return e.join(s,t)}const k=/^[a-z]+[a-z0-9-]*[a-z0-9]+$/;async function b(s,t){if(!t.match(k))throw"unsafe app name";const r=e.resolve(function(s,t){return e.join(v(s,t),"server")}(s,t),"server-hooks.js");return(await import(r)).default}const w=408,S=500;class R{static encodeMessage(e,s){return{uid:s,body:e}}renderProcess;processFilePath;renderCount=0;uid=0;queue=[];notify;constructor(e,s){this.processFilePath=e,this.notify=s}isReady(){return void 0!==this.renderProcess&&!this.renderProcess.killed}canSendMessage(){return this.isReady()&&this.renderCount<100&&this.queue.length<2}fork(){this.renderProcess&&!this.kill()||(this.renderProcess=l(this.processFilePath,[],{silent:!0,stdio:"inherit"}),this.renderProcess?(g("render process created."),this.renderProcess.on("message",this.onMessage.bind(this)),this.renderProcess.on("error",(e=>{g(JSON.stringify(e)),this.kill()}))):g("error: failed to fork render process"))}send(e){if(!this.renderProcess)return;this.renderCount=this.renderCount+1,this.uid=this.uid+1;const s=R.encodeMessage(e,this.uid);this.addToQueueWithTimeout(s),this.renderProcess.send(s)}kill(){return!(this.queue.length>0)&&(!this.renderProcess||this.renderProcess.killed?(this.renderProcess=void 0,this.renderCount=0,!0):this.renderProcess.kill()?(this.renderProcess=void 0,this.renderCount=0,g("render process killed."),!0):(g("fail to kill render process"),!1))}addToQueueWithTimeout(e){const s=setTimeout((()=>{this.removeFromQueue(e.uid)&&this.notify({message:e.body,error:{code:w,message:"render timeout"}})}),3e3);this.queue.push([e.uid,s])}removeFromQueue(e){const s=this.queue.findIndex((s=>s[0]===e));if(s>-1){const[,e]=this.queue.splice(s,1)[0];return clearTimeout(e),!0}return!1}onMessage(e){this.removeFromQueue(e.uid),this.notify(e.body),this.renderCount>=100&&this.kill()}}function $(e){return"code"in e}class C{bundleBase;apps;uid=0;renderProcessScheduler;waitingSendQueue=[];waitingResponseQueue=[];constructor(s,t=[]){this.bundleBase=s,this.apps=t,this.renderProcessScheduler=new R(e.resolve(m,"../dist/renderer-subprocess.js"),this.onMessage.bind(this)),this.renderProcessScheduler.fork()}async render(e,s){const{request:t}=s;if(-1===this.apps.indexOf(e))throw`unsupported app: ${e}`;g(`starting render for ${t.url}`),this.uid=this.uid+1;const{uid:r}=this,n={app:e,type:"render",bundlePath:this.bundleBase,uid:r,renderContext:s},i=new Promise((e=>{const t=t=>e({type:"error",renderBy:"vise:express-server",context:s,error:t});this.registerNewMessage(n,(r=>{if("string"==typeof r.data)return void t({code:S,message:r.data});if($(r.data))return void t(r.data);const{extra:n,...i}=r.data;e({type:"render",renderBy:"vise:express-server",context:a(s,{extra:n}),ssrResult:i})}))}));return this.trySendMessage(),i}registerNewMessage(e,s){this.waitingSendQueue.push([e,s])}canSendMessage(){return this.waitingSendQueue.length>0&&this.renderProcessScheduler.canSendMessage()}trySendMessage(){if(this.renderProcessScheduler.isReady()||this.renderProcessScheduler.fork(),this.canSendMessage()){const e=this.waitingSendQueue.shift();this.sendMessage(e)}}sendMessage(e){this.waitingResponseQueue.push(e),this.renderProcessScheduler.send(e[0]),g(`send render msg for ${e[0].renderContext.request.url}`)}onMessage(e){const s=e;let t;if("error"in s){const{message:e,error:r}=s;t={uid:e.uid,app:e.app,type:e.type,data:r}}else t=s;const r=this.takeFromWaitingResponseQueue(t.uid);if(r){const[e,s]=r;s(t),"render"===e.type&&g(`render process ok for url: ${e.renderContext.request.url}`)}else{let e;e="string"==typeof t.data||$(t.data)?t.data:{...t.data,html:t.data.html?.substring(0,20)},g(`error: fail to find queued msg for: ${JSON.stringify({...t,data:e})}`)}this.trySendMessage()}takeFromWaitingResponseQueue(e){const s=this.waitingResponseQueue.findIndex((s=>s[0].uid===e));if(s>-1)return this.waitingResponseQueue.splice(s,1)[0]}}class P{static corsOptions={origin:!0,optionsSuccessStatus:200,maxAge:36e3};static getPort(){return parseInt(process.env.NODE_PORT||"3000",10)}express=n();cacheService=new f;useCache;apps;base;port;repeatRender;renderService;hooksRunners={};routerBaseConfigs={};baseConfigs={};hooks={async receiveRequest(e){g(`request: ${e.url}`)},async findCache(e){if(this.useCache)return this.findCacheByInfo(e)},async hitCache(e){g(`response with cache of: ${e.key}`)},async render(e){const s=String(e.extra.app),t=await this.renderService.render(s,e);if(this.repeatRender>0)for(let t=0;t<this.repeatRender;t++)await this.renderService.render(s,e),g(`repeat render count: ${t}.`);return t},async afterRender(e){if(e.type===c.render){const{ssrResult:s,cacheInfo:t,context:r}=e,n=t?.key;n&&!r.extra.noCache?(this.cacheService.set(n,s.html),g(`render and cache with: ${n}`)):g("render without cache")}return e},async beforeResponse(e){g(`page render by: ${e.renderBy}`)}};constructor(e){this.base=e.base,this.apps=this.getSafeApps(e.apps),this.port=e.port??P.getPort(),this.repeatRender=e.repeatRender??0,this.renderService=new C(this.base,this.apps);const s=0===e.repeatRender;this.useCache=e.useCache??s,this.initHooks().then((()=>{this.setupStatic(),this.setupSSRRequest()})),this.setupRanNumRequest()}start(){this.express.listen(this.port,(()=>{g(`ssr server started: http://localhost:${this.port}`)}))}async loadHookConfig(e){return b(this.base,e)}getSafeApps(e){return e.reduce(((e,s)=>s.match(k)?(e.push(s),e):(g(`${s} is not a safe app name.`),e)),[])}async initHooks(){return await Promise.all(this.apps.map((async e=>{try{const s=await this.loadHookConfig(e);s&&s.appName===e?(this.registerBase(e,s.routerBaseConfig,!0),this.registerBase(e,s.base,!1),this.hooksRunners[e]=new d(this.addServerPlugin(s),new h(g)),g(`server hooks for "${e}" installed.`)):g(`no server hooks found for "${e}".`)}catch(s){throw console.error(`[Vise] loadServerHooks fail for "${e}".`,s),s}})))}registerBase(e,s,t){const r=t?this.routerBaseConfigs:this.baseConfigs,n=Object.keys(r).find((e=>r[e]===s));if(n)throw`${e} and ${n} has same ${t?"routerBase":"base"}: ${s}`;r[e]=s}addServerPlugin(e){const s=Object.keys(this.hooks).reduce(((e,s)=>({...e,[s]:this.hooks[s].bind(this)})),{});return{...e,plugins:[...e.plugins??[],{name:"vise:express-server",hooks:s}]}}setupSSRRequest(){this.express.use("*",((e,s)=>{const{projectName:t,routerBase:r}=u(this.routerBaseConfigs,e.originalUrl);if(!t||!this.hooksRunners[t])return void this.sendResponse(s,{code:404,headers:{},body:"Not found"});(async()=>{try{const n=await this.hooksRunners[t].start({url:e.originalUrl,headers:e.headers,body:e.body},{app:t,routerBase:r});this.sendResponse(s,n)}catch(t){const r=(e=>"string"==typeof e.stack)(t)?t.stack:t;g(`request to ${e.originalUrl} failed: ${r}`),this.sendResponse(s,{code:500,headers:{},body:String(r)})}})()}))}async sendResponse(e,s){e.set(s.headers).status(s.code).end(s.body??"")}setupStatic(){this.apps.forEach((s=>{const t=this.baseConfigs[s];0===t.indexOf("/")&&this.express.use(t,n.static(function(s,t){return e.join(v(s,t),"client")}(this.base,s),{index:!1}))}))}setupRanNumRequest(){this.express.options("/random-num",i(P.corsOptions)),this.express.get("/random-num",i(P.corsOptions),((e,s)=>{s.status(200).set({"Content-Type":"application/json"}).end(JSON.stringify({code:0,msg:"ok",data:{value:Math.round(1e4*Math.random())}}))}))}findCacheByInfo(e){const s=e.context.extra.app;return this.cacheService.get(`${s}-${e.key}`)}}async function x(s){const t=await async function(s){try{const t=await(r`cat ${s}/package.json`),n=JSON.parse(t.toString());if(Object.keys(n.dependencies).some((e=>"vise-ssr"===e)))return(await import(e.resolve(s,"dist/server/server-hooks.js"))).default.appName}catch(e){console.log(e)}return!1}(s);if(!1===t)return void console.log("input viseAppDir is not a Vise app or build is not done.");if(!t.match(k))return void console.log(`Unsafe App Name: ${t}`);const n=y(s);if(await async function(e,s=!1){return s&&await(r`rm -rf ${e}`),0===(await(r`mkdir -p ${e}`)).exitCode}(n,!0)){if(await async function(s,t){const n=v(y(s),t);return 0===(await(r`
mkdir -p ${n}
cp -r ${e.resolve(s,"package.json")} ${e.resolve(s,"dist/client")} ${e.resolve(s,"dist/server")} ${n}
rm -f ${e.join(n,"client")}/*.html
`)).exitCode}(s,t))return n;console.log("fail to copy bundles")}else console.log(`fail to create dir: ${n}`)}async function O(s,t){const n=e.isAbsolute(s)?s:e.resolve(process.cwd(),s);let i=s;if(!0!==t.bundleDir&&(i=await x(n),!i))return;const o=await async function(e){const s=await(r`ls -1 ${e}`);if(0!==s.exitCode)throw s.stderr;return s.stdout.split("\n").filter((e=>!!e))}(i),a=parseInt(t.repeatRender,10),c=t.port&&parseInt(t.port,10),d={apps:o,base:i,repeatRender:a>=0?a:0};t.enableCache&&(d.useCache="false"!==t.enableCache),c&&c>0&&(d.port=c);new P(d).start()}!async function(s){r.verbose=!1;const n=new t,i=await(r`cat ${e.resolve(m,"../package.json")}`),{version:o}=JSON.parse(i.stdout);n.version(o),n.command("start").argument("viseAppDir").description("start http listen").option("-p, --port <port>","server listen port").option("-b, --bundle-dir","serve from bundle dir instead of vise app dir").option("-c, --enable-cache <trueOrFalse>","enable server cache","true").option("-r, --repeat-render <times>","repeat ssr for benchmark test","0").action(O),n.parse(s)}(process.argv);
